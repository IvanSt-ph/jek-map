<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ê–¥—Ä–µ—Å–∞ –¢–∏—Ä–∞—Å–ø–æ–ª—è</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

  <!-- –°—Ç–∏–ª–∏ -->
  <link rel="stylesheet" href="css/style.css">
</head>

<body class="dark">

  <!-- ===================== –®–ê–ü–ö–ê ====================== -->
  <header class="topbar">
    <div class="topbar-left">
      <div class="logo">–ê–¥—Ä–µ—Å–∞ <span class="city-pill">–¢–∏—Ä–∞—Å–ø–æ–ª—å</span></div>
    </div>

    <div class="topbar-center">
      <input type="text" id="search" class="search-top" placeholder="–ü–æ–∏—Å–∫ –¥–æ–º–∞...">
    </div>

    <button id="theme-toggle" class="theme-btn">
      <span id="theme-icon">üåô</span>
    </button>
  </header>


  <!-- ===================== –õ–ï–ô–ê–£–¢ ====================== -->
  <div class="layout">

    <!-- ---------- –°–∞–π–¥–±–∞—Ä (–¥–µ—Å–∫—Ç–æ–ø) ----------- -->
    <aside id="sidebar" class="sidebar">

      <div class="sidebar-section">
        <label class="street-label" for="street-select">–£–ª–∏—Ü–∞:</label>
        <select id="street-select" class="street-select"></select>
      </div>

      <div class="sidebar-section">
        <div class="controls-row">
          <span class="chip">–í—Å–µ–≥–æ: <span id="count-all">0</span></span>
          <span class="chip">–ü–æ–∫–∞–∑–∞–Ω–æ: <span id="count-visible">0</span></span>
          <button id="reset-btn" type="button">‚ü≥ –°–±—Ä–æ—Å</button>
        </div>
      </div>

      <!-- –°–ø–∏—Å–æ–∫ –¥–æ–º–æ–≤ -->
      <ul id="address-list"></ul>

      <!-- –ò–Ω—Ñ–æ –æ –¥–æ–º–µ -->
      <section id="house-info" class="house-info">
        <div class="house-info-title">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ–º–µ</div>
        <div class="house-info-body" id="house-info-body">
          <p class="muted">–í—ã–±–µ—Ä–∏—Ç–µ –¥–æ–º –≤ —Å–ø–∏—Å–∫–µ –∏–ª–∏ –Ω–∞ –∫–∞—Ä—Ç–µ.</p>
        </div>
      </section>
    </aside>

    <!-- ---------- –ö–∞—Ä—Ç–∞ ----------- -->
    <div id="map"></div>

  </div> <!-- layout -->


  <!-- ===================== –ú–û–ë–ò–õ–¨–ù–´–ô –ù–ò–ñ–ù–ò–ô –ë–ê–† ====================== -->
  <nav class="mobile-bar">
    <button id="mb-streets">
      <span>üìç</span>
      <b>–£–ª–∏—Ü—ã</b>
    </button>

    <button id="mb-search">
      <span>üîç</span>
      <b>–ü–æ–∏—Å–∫</b>
    </button>

    <button id="mb-info">
      <span>üè†</span>
      <b>–î–æ–º</b>
    </button>

    <button id="mb-theme">
      <span>üåì</span>
      <b>–¢–µ–º–∞</b>
    </button>
  </nav>


  <!-- ===================== –ü–ê–ù–ï–õ–¨: –£–õ–ò–¶–´ ====================== -->
  <div id="panel-streets" class="mobile-panel">
    <div class="panel-header">
      <button class="panel-back">‚Üê</button>
      <span>–£–ª–∏—Ü—ã</span>
    </div>
    <div class="panel-content" id="mobile-street-list"></div>
  </div>


  <!-- ===================== –ü–ê–ù–ï–õ–¨: –ü–û–ò–°–ö ====================== -->
  <div id="panel-search" class="mobile-panel">
    <div class="panel-header">
      <button class="panel-back">‚Üê</button>
      <span>–ü–æ–∏—Å–∫</span>
    </div>

    <input
      type="text"
      id="mobile-search-input"
      class="panel-input"
      placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å..."
    >

    <div class="panel-content" id="mobile-search-results"></div>
  </div>


  <!-- ===================== –ü–ê–ù–ï–õ–¨: –ò–ù–§–û –û –î–û–ú–ï ====================== -->
  <div id="panel-info" class="mobile-panel">

    <div class="panel-header">
      <button class="panel-back">‚Üê</button>
      <span>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ–º–µ</span>
    </div>

    <div class="panel-content">

      <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ñ–æ—Ç–æ -->
      <button id="upload-photo-btn" class="info-add-photo-btn">
        –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ
      </button>

      <!-- –ì–∞–ª–µ—Ä–µ—è -->
      <div id="house-photos" class="house-photos"></div>

      <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ–º–µ -->
      <div id="mobile-house-info">
        <p class="muted">–î–æ–º –Ω–µ –≤—ã–±—Ä–∞–Ω.</p>
      </div>

    </div>

  </div>

  <!-- ===================== –°–ö–†–ò–ü–¢–´ ====================== -->

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script src="js/data.js"></script>
  <script src="js/buildings.js"></script>
  <script src="js/map.js"></script>

  <!-- Cloudinary Upload Widget (–≤–∞–∂–Ω–æ: –¥–æ ui.js) -->
  <script src="https://upload-widget.cloudinary.com/latest/global/all.js"></script>

  <script src="js/ui.js"></script>


  <script>
let CURRENT_PHOTOS = {};

// –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ –¥–ª—è –¥–æ–º–∞
async function loadPhotosFromServer(houseId) {
    try {
        const res = await fetch("/.netlify/functions/getPhotos");
        const json = await res.json();

        CURRENT_PHOTOS = json;

        return json[houseId] || [];
    } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ:", err);
        return [];
    }
}

async function savePhotoToServer(houseId, url) {
    try {
        await fetch("/.netlify/functions/savePhoto", {
            method: "POST",
            body: JSON.stringify({ houseId, url })
        });
    } catch (err) {
        console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–æ—Ç–æ:", err);
    }
}

function renderHousePhotos(houseId, photos) {
    const container = document.getElementById("house-photos");
    container.innerHTML = "";

    if (!photos.length) {
        container.innerHTML = `<p class="muted">–§–æ—Ç–æ –ø–æ–∫–∞ –Ω–µ—Ç.</p>`;
        return;
    }

    photos.forEach(url => {
        const img = document.createElement("img");
        img.src = url;
        img.style.width = "120px";
        img.style.margin = "6px";
        img.style.borderRadius = "8px";
        container.appendChild(img);
    });
}

// Cloudinary widget
onCloudinaryReady(() => {
    const btn = document.getElementById("upload-photo-btn");

    btn.addEventListener("click", () => {
        if (!window.currentAddress) {
            alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ –¥–æ–º!");
            return;
        }

        const widget = cloudinary.createUploadWidget(
            {
                cloudName: "dwstbb1fm",
                uploadPreset: "houses_unsigned",
                folder: `houses/${window.currentAddress.id}`,
                maxImageFileSize: 10 * 1024 * 1024,
                sources: ["local", "camera"]
            },
            async (err, res) => {
                if (!err && res && res.event === "success") {
                    const url = res.info.secure_url;

                    await savePhotoToServer(window.currentAddress.id, url);

                    const photos = await loadPhotosFromServer(window.currentAddress.id);
                    renderHousePhotos(window.currentAddress.id, photos);
                }
            }
        );

        widget.open();
    });
});

// –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º selectAddress —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∂–∞—Ç—å —Ñ–æ—Ç–æ
const oldSelectAddress = window.selectAddress;
window.selectAddress = async function(addr) {
    oldSelectAddress(addr);

    const photos = await loadPhotosFromServer(addr.id);
    renderHousePhotos(addr.id, photos);
};
</script>

</body>
</html>
